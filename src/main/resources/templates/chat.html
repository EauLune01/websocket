<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        :root{--bg:#0e1117;--fg:#e6edf3;--muted:#9aa4b2;--card:#161b22;--line:#2b313c;--mine:#3b82f6;--other:#22c55e;--warn:#f59e0b;--info:#60a5fa;--ok:#22c55e}
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif}
        .wrap{max-width:920px;margin:24px auto;padding:0 16px}
        .top{display:flex;gap:10px;align-items:center;margin-bottom:14px}
        .pill{margin-left:auto;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
        .grid{display:grid;grid-template-columns:260px 1fr;gap:16px}
        @media (max-width:860px){.grid{grid-template-columns:1fr}}
        .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
        .legend{font-size:12px;color:var(--muted);margin-bottom:8px}
        .hr{height:1px;background:var(--line);margin:10px 0;border-radius:1px}
        .chat{height:56vh;min-height:360px;max-height:70vh;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:12px}
        .msg{max-width:76%;padding:10px 12px;border-radius:16px;border:1px solid var(--line)}
        .msg.mine{align-self:flex-end;background:rgba(59,130,246,.10);border-color:rgba(59,130,246,.35)}
        .msg.other{align-self:flex-start;background:rgba(34,197,94,.10);border-color:rgba(34,197,94,.35)}
        .meta{display:flex;gap:8px;align-items:center;margin-bottom:4px;font-size:12px;color:var(--muted)}
        .meta .name{font-weight:700;color:#cbd5e1}
        .content{white-space:pre-wrap;line-height:1.45}
        .status{padding:2px 6px;border-radius:999px;border:1px solid var(--line)}
        .SENT{color:var(--warn);border-color:#5a4d1d}
        .DELIVERED{color:var(--info);border-color:#234d8a}
        .READ{color:var(--ok);border-color:#1c5a34}
        .actions{display:flex;gap:6px;margin-top:8px}
        .btn-action{padding:2px 6px;font-size:11px;border-radius:6px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--muted);cursor:pointer}
        .btn-action:hover{filter:brightness(1.2)}
        input[type="text"]{flex:1;min-width:140px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1526;color:#e6edf3}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0c1220;color:#e6edf3;cursor:pointer}
        .btn:hover{filter:brightness(1.06)}
        .btn.ghost{background:rgba(255,255,255,.02)}
        a.btn{text-decoration:none}
        /* âœ… ìˆ˜ì •ëœ ë¶€ë¶„: flex-wrap: wrap ì œê±° */
        .toolbar{display:flex;gap:10px;align-items:center;margin-top:10px}
        .small{font-size:12px;color:var(--muted)}
    </style>
</head>
<body>
<div class="wrap">
    <div class="top">
        <h2 style="margin:0">ì‹¤ì‹œê°„ ì±„íŒ…</h2>
        <span class="pill" th:text="${roomLabel}">room: -</span>
    </div>
    <div class="grid">
        <aside class="card">
            <div class="legend">ì ‘ì† ì •ë³´</div>
            <div style="font-weight:700;margin-bottom:8px;" th:text="'í˜„ì¬ ì‚¬ìš©ì: ' + ${displayName}">-</div>
            <div class="hr"></div>
            <div class="legend">ë„ì›€ë§</div>
            <p class="small">
                â€¢ ìƒëŒ€ íƒ­(í˜¹ì€ ë¸Œë¼ìš°ì €)ì—ì„œ ì´ ë°©ì— ì…ì¥í•˜ë©´, ìƒëŒ€ê°€ ë³´ë‚¸ DELIVEREDê°€ ì¦‰ì‹œ READë¡œ ìŠ¹ê²©ë©ë‹ˆë‹¤.<br/>
                â€¢ ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” <b>READ ì´ì „</b>(= SENT/DELIVERED)ê¹Œì§€ë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥.
            </p>
            <div class="hr"></div>
            <button id="btn-refresh" class="btn ghost">ìµœê·¼ ë‚´ì—­ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°</button>
            <a class="btn" th:href="@{/index}" style="margin-left:8px">ì‚¬ìš©ì ì„ íƒìœ¼ë¡œ</a>
        </aside>
        <main class="card">
            <div id="chat" class="chat"></div>
            <div class="hr"></div>
            <div class="toolbar">
                <input type="text" id="msg" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter ì „ì†¡)" />
                <button id="btn-send" class="btn">ì „ì†¡</button>
            </div>
        </main>
    </div>
</div>

<script th:inline="javascript">
    const ROOM_ID = /*[[${room}]]*/ '';
    const currentUserUid = /*[[${userUid}]]*/ '';
</script>

<script>
    // ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©ì€ ì´ì „ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµí•©ë‹ˆë‹¤.
    console.log("âœ… ROOM_ID =", ROOM_ID);
    console.log("âœ… currentUserUid =", currentUserUid);

    let client = null;
    const $ = (s) => document.querySelector(s);
    const chatEl = $('#chat');
    const messageEls = new Map();
    const fmt = (x) => {
        if (!x) return '';
        const date = new Date(x);
        return isNaN(date) ? 'ì‹œê°„ì •ë³´ ì—†ìŒ' : date.toLocaleTimeString();
    };

    function editMessage(id) {
        const newContent = prompt("ìƒˆ ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (newContent === null || newContent.trim() === '') return;
        if (!ensureActive()) return;

        client.send('/app/edit', {}, JSON.stringify({
            messageId: id,
            editorUid: currentUserUid,
            newContent: newContent.trim()
        }));
    }

    function deleteMessage(id) {
        if (!confirm("ë©”ì‹œì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
        if (!ensureActive()) return;

        client.send('/app/delete', {}, JSON.stringify({
            messageId: id,
            requesterUid: currentUserUid
        }));
    }

    function upsertMessage(m) {
        const mine = m.senderUid === currentUserUid;
        const cls = mine ? 'mine' : 'other';
        let box = messageEls.get(m.id);

        if (!box) {
            box = document.createElement('div');
            box.className = `msg ${cls}`;
            box.dataset.id = m.id;
            box.innerHTML = `
              <div class="meta">
                <span class="name">${m.senderName}</span>
                <span class="time">${fmt(m.createdAt)}</span>
                <span class="status ${m.status}">${m.status}</span>
              </div>
              <div class="content"></div>
              <div class="actions"></div>
            `;
            chatEl.appendChild(box);
            messageEls.set(m.id, box);
        }

        box.querySelector('.content').textContent = m.content;
        const st = box.querySelector('.status');
        st.textContent = m.status;
        st.className = `status ${m.status}`;

        const actionsEl = box.querySelector('.actions');
        actionsEl.innerHTML = '';
        if (mine && (m.status === 'SENT' || m.status === 'DELIVERED')) {
            actionsEl.innerHTML = `
                <button class="btn-action" onclick="editMessage(${m.id})">ìˆ˜ì •</button>
                <button class="btn-action" onclick="deleteMessage(${m.id})">ì‚­ì œ</button>
            `;
        }

        chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function fetchHistory(limit = 50) {
        const r = await fetch(`/api/rooms/${ROOM_ID}/messages?limit=${limit}`);
        if (!r.ok) { alert('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨'); return; }
        const data = await r.json();
        chatEl.innerHTML = '';
        messageEls.clear();
        data.forEach(upsertMessage);
    }

    function connectWS() {
        const sock = new SockJS('/ws');
        client = Stomp.over(sock);
        client.debug = null;

        client.connect({}, () => {
            console.log("âœ… Connected to STOMP successfully!");

            client.subscribe(`/topic/rooms/${ROOM_ID}`, (msg) => {
                const payload = JSON.parse(msg.body);
                console.log("ğŸ“© Message received:", payload);

                if (payload.type === 'deleted') {
                    const messageId = payload.messageId;
                    const el = messageEls.get(messageId);
                    if (el) {
                        el.remove();
                        messageEls.delete(messageId);
                        console.log(`ğŸ—‘ï¸ Message ${messageId} deleted.`);
                    }
                }
                else {
                    upsertMessage(payload);
                }
            });

            client.send('/app/enter', {}, JSON.stringify({
                roomId: ROOM_ID,
                userUid: currentUserUid
            }));

            setTimeout(() => fetchHistory(50), 200);
        }, (err) => {
            console.error('âŒ STOMP connect error', err);
            alert('WebSocket ì—°ê²° ì‹¤íŒ¨');
        });
    }

    function ensureActive() {
        if (!client || !client.connected) {
            alert('ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return false;
        }
        return true;
    }

    function sendMessage(text) {
        const content = (text ?? '').trim();
        if (!content || !ensureActive()) return;

        client.send('/app/send', {}, JSON.stringify({
            roomId: ROOM_ID,
            senderUid: currentUserUid,
            content
        }));
    }

    window.addEventListener('DOMContentLoaded', () => {
        fetchHistory(50);
        connectWS();

        const msgInput = $('#msg');
        $('#btn-send').addEventListener('click', () => {
            sendMessage(msgInput.value);
            msgInput.value = '';
            msgInput.focus();
        });
        msgInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.isComposing) {
                e.preventDefault();
                sendMessage(e.target.value);
                e.target.value = '';
            }
        });
        $('#btn-refresh').addEventListener('click', e => {
            e.preventDefault();
            fetchHistory(50);
        });
    });
</script>
</body>
</html>