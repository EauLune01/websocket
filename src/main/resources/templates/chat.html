<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>실시간 채팅</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        :root{--bg:#0e1117;--fg:#e6edf3;--muted:#9aa4b2;--card:#161b22;--line:#2b313c;--mine:#3b82f6;--other:#22c55e;--warn:#f59e0b;--info:#60a5fa;--ok:#22c55e}
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif}
        .wrap{max-width:920px;margin:24px auto;padding:0 16px}
        .top{display:flex;gap:10px;align-items:center;margin-bottom:14px}
        .pill{margin-left:auto;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
        .grid{display:grid;grid-template-columns:260px 1fr;gap:16px}
        @media (max-width:860px){.grid{grid-template-columns:1fr}}
        .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
        .legend{font-size:12px;color:var(--muted);margin-bottom:8px}
        .hr{height:1px;background:var(--line);margin:10px 0;border-radius:1px}
        .chat{height:56vh;min-height:360px;max-height:70vh;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:12px}
        .msg{max-width:76%;padding:10px 12px;border-radius:16px;border:1px solid var(--line)}
        .msg.mine{align-self:flex-end;background:rgba(59,130,246,.10);border-color:rgba(59,130,246,.35)}
        .msg.other{align-self:flex-start;background:rgba(34,197,94,.10);border-color:rgba(34,197,94,.35)}
        .meta{display:flex;gap:8px;align-items:center;margin-bottom:4px;font-size:12px;color:var(--muted)}
        .meta .name{font-weight:700;color:#cbd5e1}
        .content{white-space:pre-wrap;line-height:1.45}
        .status{padding:2px 6px;border-radius:999px;border:1px solid var(--line)}
        .SENT{color:var(--warn);border-color:#5a4d1d}
        .DELIVERED{color:var(--info);border-color:#234d8a}
        .READ{color:var(--ok);border-color:#1c5a34}
        .actions{display:flex;gap:6px;margin-top:8px}
        .btn-action{padding:2px 6px;font-size:11px;border-radius:6px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--muted);cursor:pointer}
        .btn-action:hover{filter:brightness(1.2)}
        input[type="text"]{flex:1;min-width:140px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1526;color:#e6edf3}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0c1220;color:#e6edf3;cursor:pointer}
        .btn:hover{filter:brightness(1.06)}
        .btn.ghost{background:rgba(255,255,255,.02)}
        a.btn{text-decoration:none}
        /* ✅ 수정된 부분: flex-wrap: wrap 제거 */
        .toolbar{display:flex;gap:10px;align-items:center;margin-top:10px}
        .small{font-size:12px;color:var(--muted)}
    </style>
</head>
<body>
<div class="wrap">
    <div class="top">
        <h2 style="margin:0">실시간 채팅</h2>
        <span class="pill" th:text="${roomLabel}">room: -</span>
    </div>
    <div class="grid">
        <aside class="card">
            <div class="legend">접속 정보</div>
            <div style="font-weight:700;margin-bottom:8px;" th:text="'현재 사용자: ' + ${displayName}">-</div>
            <div class="hr"></div>
            <div class="legend">도움말</div>
            <p class="small">
                • 상대 탭(혹은 브라우저)에서 이 방에 입장하면, 상대가 보낸 DELIVERED가 즉시 READ로 승격됩니다.<br/>
                • 내가 보낸 메시지는 <b>READ 이전</b>(= SENT/DELIVERED)까지만 수정/삭제 가능.
            </p>
            <div class="hr"></div>
            <button id="btn-refresh" class="btn ghost">최근 내역 다시 가져오기</button>
            <a class="btn" th:href="@{/index}" style="margin-left:8px">사용자 선택으로</a>
        </aside>
        <main class="card">
            <div id="chat" class="chat"></div>
            <div class="hr"></div>
            <div class="toolbar">
                <input type="text" id="msg" placeholder="메시지를 입력하세요 (Enter 전송)" />
                <button id="btn-send" class="btn">전송</button>
            </div>
        </main>
    </div>
</div>

<script th:inline="javascript">
    const ROOM_ID = /*[[${room}]]*/ '';
    const currentUserUid = /*[[${userUid}]]*/ '';
</script>

<script>
    // 스크립트 내용은 이전과 동일하므로 생략합니다.
    console.log("✅ ROOM_ID =", ROOM_ID);
    console.log("✅ currentUserUid =", currentUserUid);

    let client = null;
    const $ = (s) => document.querySelector(s);
    const chatEl = $('#chat');
    const messageEls = new Map();
    const fmt = (x) => {
        if (!x) return '';
        const date = new Date(x);
        return isNaN(date) ? '시간정보 없음' : date.toLocaleTimeString();
    };

    function editMessage(id) {
        const newContent = prompt("새 메시지 내용을 입력하세요:");
        if (newContent === null || newContent.trim() === '') return;
        if (!ensureActive()) return;

        client.send('/app/edit', {}, JSON.stringify({
            messageId: id,
            editorUid: currentUserUid,
            newContent: newContent.trim()
        }));
    }

    function deleteMessage(id) {
        if (!confirm("메시지를 삭제할까요?")) return;
        if (!ensureActive()) return;

        client.send('/app/delete', {}, JSON.stringify({
            messageId: id,
            requesterUid: currentUserUid
        }));
    }

    function upsertMessage(m) {
        const mine = m.senderUid === currentUserUid;
        const cls = mine ? 'mine' : 'other';
        let box = messageEls.get(m.id);

        if (!box) {
            box = document.createElement('div');
            box.className = `msg ${cls}`;
            box.dataset.id = m.id;
            box.innerHTML = `
              <div class="meta">
                <span class="name">${m.senderName}</span>
                <span class="time">${fmt(m.createdAt)}</span>
                <span class="status ${m.status}">${m.status}</span>
              </div>
              <div class="content"></div>
              <div class="actions"></div>
            `;
            chatEl.appendChild(box);
            messageEls.set(m.id, box);
        }

        box.querySelector('.content').textContent = m.content;
        const st = box.querySelector('.status');
        st.textContent = m.status;
        st.className = `status ${m.status}`;

        const actionsEl = box.querySelector('.actions');
        actionsEl.innerHTML = '';
        if (mine && (m.status === 'SENT' || m.status === 'DELIVERED')) {
            actionsEl.innerHTML = `
                <button class="btn-action" onclick="editMessage(${m.id})">수정</button>
                <button class="btn-action" onclick="deleteMessage(${m.id})">삭제</button>
            `;
        }

        chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function fetchHistory(limit = 50) {
        const r = await fetch(`/api/rooms/${ROOM_ID}/messages?limit=${limit}`);
        if (!r.ok) { alert('히스토리 로드 실패'); return; }
        const data = await r.json();
        chatEl.innerHTML = '';
        messageEls.clear();
        data.forEach(upsertMessage);
    }

    function connectWS() {
        const sock = new SockJS('/ws');
        client = Stomp.over(sock);
        client.debug = null;

        client.connect({}, () => {
            console.log("✅ Connected to STOMP successfully!");

            client.subscribe(`/topic/rooms/${ROOM_ID}`, (msg) => {
                const payload = JSON.parse(msg.body);
                console.log("📩 Message received:", payload);

                if (payload.type === 'deleted') {
                    const messageId = payload.messageId;
                    const el = messageEls.get(messageId);
                    if (el) {
                        el.remove();
                        messageEls.delete(messageId);
                        console.log(`🗑️ Message ${messageId} deleted.`);
                    }
                }
                else {
                    upsertMessage(payload);
                }
            });

            client.send('/app/enter', {}, JSON.stringify({
                roomId: ROOM_ID,
                userUid: currentUserUid
            }));

            setTimeout(() => fetchHistory(50), 200);
        }, (err) => {
            console.error('❌ STOMP connect error', err);
            alert('WebSocket 연결 실패');
        });
    }

    function ensureActive() {
        if (!client || !client.connected) {
            alert('연결되지 않았습니다.');
            return false;
        }
        return true;
    }

    function sendMessage(text) {
        const content = (text ?? '').trim();
        if (!content || !ensureActive()) return;

        client.send('/app/send', {}, JSON.stringify({
            roomId: ROOM_ID,
            senderUid: currentUserUid,
            content
        }));
    }

    window.addEventListener('DOMContentLoaded', () => {
        fetchHistory(50);
        connectWS();

        const msgInput = $('#msg');
        $('#btn-send').addEventListener('click', () => {
            sendMessage(msgInput.value);
            msgInput.value = '';
            msgInput.focus();
        });
        msgInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.isComposing) {
                e.preventDefault();
                sendMessage(e.target.value);
                e.target.value = '';
            }
        });
        $('#btn-refresh').addEventListener('click', e => {
            e.preventDefault();
            fetchHistory(50);
        });
    });
</script>
</body>
</html>